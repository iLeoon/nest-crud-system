services:
  postgres:
      build: ./Docker/postgres
      environment:
        POSTGRES_USER: "user"
        POSTGRES_PASSWORD: "admin"
        POSTGRES_DB: "northwind"
      ports:
        - "5432:5432"
      restart: unless-stopped
      volumes:
        - data:/var/lib/postgresql/data
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}" ]
        interval: 10s
        timeout: 5s
  
  mongodb: 
    image: mongo:latest
    restart: unless-stopped
    environment:
        MONGO_INITDB_ROOT_USERNAME: user
        MONGO_INITDB_ROOT_PASSWORD: admin
        MONGO_INITDB_DATABASE: test
    ports:
        - 27017:27017
    volumes:
        - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro

  nest:
    build:
      context: .
      dockerfile: packages/nest/Dockerfile
    ports:
      - "3000:3000"
    restart: unless-stopped
    env_file:
      - ./packages/nest/.env
    environment:
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: user
      DATABASE_PASSWORD: admin
      DATABASE_NAME: northwind
      NEXT_API_URL: http://localhost:3001
      MONGO_URI: mongodb://user:admin@mongodb:27017/test?authSource=admin
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_started

  next:
    build:
      context: .
      dockerfile: packages/next/Dockerfile
      args:
        NEXT_PUBLIC_NEST_API_URL: http://localhost:3000
    ports:
      - "3001:3001"
    restart: unless-stopped
    depends_on:
      - nest

volumes:
  data: